const categoriesData = {
    "Bundesliga-Einsätze wie": [
      { name: "Luca Toni", value: 60.0 }, { name: "Grafite", value: 107.0 }, { name: "Simon Terodde", value: 90.0 },
      { name: "Sejad Salihovic", value: 186.0 }, { name: "Kevin Volland", value: 277.0 }, { name: "Lukas Podolski", value: 210.0 },
      { name: "Ailton", value: 219.0 }, { name: "Michael Rensing", value: 136.0 }, { name: "Andreas Beck", value: 290.0 },
      { name: "Cacau", value: 307.0 }, { name: "Leonardo Bonucci", value: 7.0 }, { name: "Florian Fromlowitz", value: 70.0 },
      { name: "Massimo Oddo", value: 18.0 }, { name: "Xabi Alonso", value: 79.0 }, { name: "Luca Barrios", value: 83.0 },
      { name: "Tim Wiese", value: 269.0 }, { name: "Hugo Almeida", value: 124.0 }, { name: "Klaas-Jan Huntelaar", value: 184.0 },
      { name: "Raùl", value: 66.0 }, { name: "Ralf Fährmann", value: 230.0 }, { name: "Robert Enke", value: 196.0 },
      { name: "Bo Svensson", value: 122.0 }, { name: "Diego Benaglio", value: 259.0 }, { name: "Timo Hildebrand", value: 301.0 },
      { name: "Demba Ba", value: 67.0 }, { name: "Chinedu Obasi", value: 100.0 }, { name: "Steven Cherundolo", value: 302.0 },
      { name: "Owen Hargreaves", value: 145.0 }, { name: "Christoph Kramer", value: 271.0 }, { name: "Mike Hanke", value: 284.0 },
      { name: "Karim Haggui", value: 172.0 }, { name: "Patrick Helmes", value: 98.0 }, { name: "Sven Bender", value: 265.0 },
      { name: "Marcel Risse", value: 176.0 }, { name: "Paul Freier", value: 249.0 }, { name: "Diego Contento", value: 49.0 },
      { name: "Thiago Alcantara", value: 150.0 }, { name: "Sandro Wagner", value: 180.0 }, { name: "Marko Pantelic", value: 114.0 },
      { name: "Toni Kroos", value: 173.0 }, { name: "Gabor Kiràly", value: 198.0 }, { name: "Nils Petersen", value: 295.0 },
      { name: "Felipe Santana", value: 119.0 }, { name: "Breno", value: 28.0 }, { name: "Pedro Geromel", value: 116.0 },
      { name: "Mohamadou Idrissou", value: 139.0 }, { name: "Dani Carvajal", value: 32.0 }, { name: "Martin Hinteregger", value: 190.0 },
      { name: "Landon Donovan", value: 13.0 }, { name: "Felix Kroos", value: 80.0 }, { name: "Petri Pasanen", value: 144.0 },
      { name: "Javier Pinola", value: 203.0 }, { name: "Tranquilo Barnetta", value: 260.0 }, { name: "Jaroslav Drobny", value: 202.0 },
      { name: "Karim Matmour", value: 101.0 }, { name: "Logan Bailly", value: 61.0 }, { name: "Koen Casteels", value: 283.0 },
      { name: "Felix Wiedwald", value: 73.0 }, { name: "Jefferson Farfan", value: 170.0 }, { name: "Joel Matip", value: 194.0 }
    ],
  
  "Bundesliga-Tore wie": [
    { name: "Luca Toni", value: 38.0 }, { name: "Hans-Jörg Butt", value: 26.0 }, { name: "Grafite", value: 59.0 },
    { name: "Simon Terodde", value: 15.0 }, { name: "Sejad Salihovic", value: 47.0 }, { name: "Kevin Volland", value: 80.0 },
    { name: "Lukas Podolski", value: 70.0 }, { name: "Ailton", value: 106.0 }, { name: "Cacau", value: 88.0 },
    { name: "Lucas Barrios", value: 39.0 }, { name: "Hugo Almeida", value: 42.0 }, { name: "Klaas-Jan Huntelaar", value: 84.0 },
    { name: "Raùl", value: 28.0 }, { name: "Demba Ba", value: 25.0 }, { name: "Chinedu Obasi", value: 17.0 },
    { name: "Steven Cherundolo", value: 6.0 }, { name: "Christoph Kramer", value: 10.0 }, { name: "Mike Hanke", value: 57.0 },
    { name: "Karim Haggui", value: 11.0 }, { name: "Patrick Helmes", value: 45.0 }, { name: "Marcel Risse", value: 15.0 },
    { name: "Paul Freier", value: 29.0 }, { name: "Stefan Kießling", value: 144.0 }, { name: "Thiago Alcantara", value: 17.0 },
    { name: "Sandro Wagner", value: 44.0 }, { name: "Marko Pantelic", value: 44.0 }, { name: "Toni Kroos", value: 23.0 },
    { name: "Nils Petersen", value: 89.0 }, { name: "Mohamadou Idrissou", value: 27.0 }, { name: "Vedad Ibisevic", value: 127.0 },
    { name: "Martin Hinteregger", value: 17.0 }, { name: "Tranquilo Barnetta", value: 29.0 }, { name: "Halil Altintop", value: 67.0 },
    { name: "Jefferson Farfan", value: 39.0 }
  ],

"Länderspiel-Einsätze wie": [
  { name: "Luca Toni", value: 47.0 }, { name: "Hans-Jörg Butt", value: 4.0 }, { name: "Grafite", value: 4.0 },
  { name: "Sejad Salihovic", value: 47.0 }, { name: "Kevin Volland", value: 15.0 }, { name: "Lukas Podolski", value: 130.0 },
  { name: "Andreas Beck", value: 9.0 }, { name: "Cacau", value: 23.0 }, { name: "Leonardo Bonucci", value: 121.0 },
  { name: "Massimo Oddo", value: 34.0 }, { name: "Xabi Alonso", value: 114.0 }, { name: "Lucas Barrios", value: 36.0 },
  { name: "Hugo Almeida", value: 57.0 }, { name: "Klaas-Jan Huntelaar", value: 76.0 }, { name: "Raùl", value: 102.0 },
  { name: "Robert Enke", value: 8.0 }, { name: "Bo Svensson", value: 3.0 }, { name: "Timo Hildebrand", value: 7.0 },
  { name: "Demba Ba", value: 22.0 }, { name: "Chinedu Obasi", value: 21.0 }, { name: "Steven Cherundolo", value: 87.0 },
  { name: "Owen Hargreaves", value: 42.0 }, { name: "Christoph Kramer", value: 12.0 }, { name: "Karim Haggui", value: 82.0 },
  { name: "Didier Drogba", value: 105.0 }, { name: "Petr Cech", value: 142.0 }, { name: "Thiago Alcantara", value: 46.0 },
  { name: "Sandro Wagner", value: 8.0 }, { name: "Marko Pantelic", value: 43.0 }, { name: "Toni Kroos", value: 114.0 },
  { name: "Mohamadou Idrissou", value: 39.0 }, { name: "Luis Suarez", value: 143.0 }, { name: "Dani Alves", value: 126.0 },
  { name: "Dani Carvajal", value: 51.0 }, { name: "Martin Hinteregger", value: 67.0 }, { name: "Karim Benzema", value: 97.0 },
  { name: "Petri Pasanen", value: 78.0 }, { name: "Teemu Pukki", value: 129.0 }, { name: "Tranquilo Barnetta", value: 75.0 },
  { name: "Karim Matmour", value: 30.0 }, { name: "Zlatan Ibrahimović", value: 122.0 }, { name: "Koen Casteels", value: 20.0 }
],

"Gelbe Karten im Herrenbereich wie": [
    { name: "Luca Toni", value: 85.0 }, { name: "Hans-Jörg Butt", value: 10.0 }, { name: "Sejad Salihovic", value: 93.0 },
    { name: "Kevin Volland", value: 78.0 }, { name: "Lukas Podolski", value: 113.0 }, { name: "Ailton", value: 54.0 },
    { name: "Andreas Beck", value: 95.0 }, { name: "Cacau", value: 91.0 }, { name: "Leonardo Bonucci", value: 117.0 },
    { name: "Massimo Oddo", value: 74.0 }, { name: "Xabi Alonso", value: 187.0 }, { name: "Lucas Barrios", value: 58.0 },
    { name: "Raùl", value: 49.0 }, { name: "Bo Svensson", value: 39.0 }, { name: "Chinedu Obasi", value: 35.0 },
    { name: "Steven Cherundolo", value: 70.0 }, { name: "Owen Hargreaves", value: 44.0 }, { name: "Christoph Kramer", value: 91.0 },
    { name: "Karim Haggui", value: 63.0 }, { name: "Sven Bender", value: 47.0 }, { name: "Felipe Santana", value: 27.0 },
    { name: "Breno", value: 27.0 }, { name: "Pedro Geromel", value: 131.0 }, { name: "Vedad Ibisevic", value: 81.0 },
    { name: "Martin Hinteregger", value: 85.0 }, { name: "Felix Kroos", value: 72.0 }, { name: "Petri Pasanen", value: 47.0 },
    { name: "Teemu Pukki", value: 32.0 }, { name: "Javier Pinola", value: 157.0 }, { name: "Tranquilo Barnetta", value: 67.0 },
    { name: "Zlatan Ibrahimović", value: 126.0 }
  ],

  "Generierte Transfersablösen wie": [
    { name: "Luca Toni", value: 42.55 }, { name: "Kevin Volland", value: 35.7 }, { name: "Lukas Podolski", value: 40.7 },
    { name: "Ailton", value: 7.3 }, { name: "Leonardo Bonucci", value: 107.04 }, { name: "Massimo Oddo", value: 10.82 },
    { name: "Xabi Alonso", value: 59.5 }, { name: "Lucas Barrios", value: 22.1 }, { name: "Klaas-Jan Huntelaar", value: 65.9 },
    { name: "Demba Ba", value: 34.3 }, { name: "Owen Hargreaves", value: 25.0 }, { name: "Christoph Kramer", value: 15.2 },
    { name: "Didier Drogba", value: 44.6 }, { name: "Thiago Alcantara", value: 47.0 }, { name: "Sandro Wagner", value: 21.7 },
    { name: "Toni Kroos", value: 27.3 }, { name: "Javi Martinez", value: 46.0 }, { name: "Luis Suarez", value: 125.52 },
    { name: "Dani Alves", value: 36.55 }, { name: "Karim Benzema", value: 35.0 }, { name: "Cristiano Ronaldo", value: 247.0 },
    { name: "Zlatan Ibrahimović", value: 169.1 }
  ],

"Bundesliga-Einsätze zu Null wie": [
    { name: "Michael Rensing", value: 35.0 }, { name: "Florian Fromlowitz", value: 13.0 }, { name: "Tim Wiese", value: 75.0 },
    { name: "Ralf Fährmann", value: 67.0 }, { name: "Robert Enke", value: 48.0 }, { name: "Diego Benaglio", value: 62.0 },
    { name: "Timo Hildebrand", value: 100.0 }, { name: "Gabor Kiràly", value: 72.0 }, { name: "Bernd Leno", value: 74.0 },
    { name: "Raphael Schäfer", value: 64.0 }, { name: "Tomislav Piplica", value: 29.0 }, { name: "Thomas Kraft", value: 31.0 },
    { name: "Jens Lehmann", value: 131.0 }, { name: "Marc-André ter Stegen", value: 36.0 }, { name: "Frank Rost", value: 121.0 },
    { name: "René Adler", value: 69.0 }, { name: "Jarsolav Drobny", value: 58.0 }, { name: "Logan Bailly", value: 10.0 },
    { name: "Koen Casteels", value: 80.0 }, { name: "Yann Sommer", value: 77.0 }, { name: "Marwin Hitz", value: 58.0 },
    { name: "Felix Wiedwald", value: 9.0 }
  ]
};


let players = [];
let scores = {};
let round = 0;
const maxRounds = 10;
let currentStartPlayer = "";
let currentCorrectItem = null;
let isBotActive = false;
const botName = "Bot Kevin";
let botGuessForRound = null;
let botReferenceItemName = null;

function startGame() {
  const humanPlayerCount = parseInt(document.getElementById("playerCount").value);
  isBotActive = document.getElementById("activateBotCheckbox").checked;
  let totalPlayerCount = humanPlayerCount;

  if (isBotActive) {
    totalPlayerCount++;
  }

  if (totalPlayerCount < 2 || totalPlayerCount > 8) {
    alert("Die Gesamtspielerzahl (inkl. Bot) muss zwischen 2 und 8 liegen.");
    return;
  }

  players = [];
  scores = {};

  for (let i = 0; i < humanPlayerCount; i++) {
    const name = document.getElementById(`playerName${i}`)?.value.trim() || `Spieler ${i + 1}`;
    players.push(name);
    scores[name] = 0;
  }

  if (isBotActive) {
    players.push(botName);
    scores[botName] = 0;
  }

  round = 0; // Reset round counter
  document.getElementById("startScreen").classList.add("hidden");
  newRound();
}

function generateBotGuess() {
  if (!isBotActive || !currentCorrectItem) {
    botGuessForRound = null;
    return;
  }

  const categoryKeys = Object.keys(categoriesData);
  let currentCategoryKey = null;
  for (const key of categoryKeys) {
    if (categoriesData[key].includes(currentCorrectItem)) {
      currentCategoryKey = key;
      break;
    }
  }

  if (!currentCategoryKey) {
    console.error("Bot: Could not determine current category for item:", currentCorrectItem);
    botGuessForRound = parseFloat(currentCorrectItem.value) * (Math.random() * 0.4 + 0.8); // Guess based on actual value +/- 20%
    return;
  }

  const itemsInSameCategory = categoriesData[currentCategoryKey].filter(item => item !== currentCorrectItem);

  let referenceItem;
  if (itemsInSameCategory.length > 0) {
    referenceItem = itemsInSameCategory[Math.floor(Math.random() * itemsInSameCategory.length)];
  } else {
    // Fallback: if no *other* item, use current item as base (less ideal but prevents error)
    referenceItem = currentCorrectItem; 
    console.warn("Bot: No other items in category to pick from, using current item as reference.");
  }

  const baseValue = parseFloat(referenceItem.value);
  const modificationPercentage = (Math.random() * 0.6) - 0.3; // Randomly +/- 0% to 30%
  let guess = baseValue * (1 + modificationPercentage);

  // Ensure guess is not negative and format it (e.g., to 2 decimal places or integer)
  guess = Math.max(0, guess);
  if (Number.isInteger(baseValue)) {
    botGuessForRound = Math.round(guess);
  } else {
    botGuessForRound = parseFloat(guess.toFixed(2));
  }
  botReferenceItemName = referenceItem ? referenceItem.name : "Unbekannt";
  // console.log(`Bot (${botName}) guess for ${currentCorrectItem.name} (actual: ${currentCorrectItem.value}) is ${botGuessForRound}, based on ${botReferenceItemName} (actual: ${referenceItem.value})`);
}

function newRound() {
  botReferenceItemName = null; // Reset for the new round
  if (round >= maxRounds) {
    showEndScreen();
    return;
  }
  round++;

  const categoryKeys = Object.keys(categoriesData);
  if (categoryKeys.length === 0) {
    console.error("No categories found in categoriesData!");
    document.getElementById("categoryDisplay").textContent = "Fehler: Keine Kategorien geladen!";
    document.getElementById("personDisplay").textContent = "";
    return;
  }
  const randomCategoryKey = categoryKeys[Math.floor(Math.random() * categoryKeys.length)];
  const itemsInCategory = categoriesData[randomCategoryKey];

  if (!itemsInCategory || itemsInCategory.length === 0) {
     console.error(`No items found in category: ${randomCategoryKey}`);
     document.getElementById("categoryDisplay").textContent = `Fehler: Keine Einträge in Kategorie ${randomCategoryKey}!`;
     document.getElementById("personDisplay").textContent = "Bitte lade die Seite neu oder prüfe die Daten.";
     // Consider retrying or providing a way to skip
     // For now, we'll try to pick another category if this happens, up to a few times
     // This is a simplified retry, ideally you'd handle this more robustly
     if (categoryKeys.length > 1) { // Avoid infinite loop if only one bad category
        console.log("Retrying category selection...");
        newRound(); // Recursive call, be cautious with this pattern
     } 
     return;
  }
  currentCorrectItem = itemsInCategory[Math.floor(Math.random() * itemsInCategory.length)];
  currentStartPlayer = players[Math.floor(Math.random() * players.length)];

  document.getElementById("categoryDisplay").textContent = `${randomCategoryKey} – ${currentStartPlayer} beginnt`;
  document.getElementById("personDisplay").textContent = `Gesucht: ${currentCorrectItem.name}`;

  document.getElementById("roundScreen").classList.remove("hidden");
  document.getElementById("inputScreen").classList.add("hidden");
  document.getElementById("pointsScreen").classList.add("hidden");

  if (isBotActive) {
    generateBotGuess(); // Generate bot's guess AFTER currentCorrectItem is set for the new round
  }
}

function showInputScreen() {
  document.getElementById("roundScreen").classList.add("hidden");
  document.getElementById("inputScreen").classList.remove("hidden");
  document.getElementById("mainNumber").value = currentCorrectItem ? currentCorrectItem.value : "";
  document.getElementById("mainNumber").readOnly = false; // Allow admin to change if needed, but primarily for display
  document.getElementById("leftNumber").value = "";
  document.getElementById("rightNumber").value = "";
  document.getElementById("diffLeft").textContent = "-";
  document.getElementById("diffRight").textContent = "-";

  const botDisplay = document.getElementById("botGuessDisplayArea");
  if (isBotActive && botGuessForRound !== null && botReferenceItemName) {
    botDisplay.textContent = `${botName}: ${botReferenceItemName} (${botGuessForRound})`;
    botDisplay.style.display = "block";
  } else {
    botDisplay.style.display = "none";
  }
  updateDiffs(); // Update diffs after mainNumber is set and bot display is handled
}

function updateDiffs() {
  const mainInput = document.getElementById("mainNumber");
  const leftInput = document.getElementById("leftNumber");
  const rightInput = document.getElementById("rightNumber");

  // Use parseFloat as values can be decimals.
  const main = parseFloat(mainInput.value);
  const left = parseFloat(leftInput.value);
  const right = parseFloat(rightInput.value);

  // Check if parsing was successful, otherwise treat as 0 or indicate error
  const mainValue = isNaN(main) ? 0 : main;
  // For left and right, if empty or invalid, we might not want to show a diff or show '-' 
  // Let's calculate diff only if left/right are valid numbers

  let diffLeftText = "-";
  if (!isNaN(left) && leftInput.value.trim() !== "") { // only calculate if left is a number and input is not empty
      diffLeftText = (mainValue - left).toFixed(2);
  }

  let diffRightText = "-";
  if (!isNaN(right) && rightInput.value.trim() !== "") { // only calculate if right is a number and input is not empty
      diffRightText = (mainValue - right).toFixed(2);
  }

  document.getElementById("diffLeft").textContent = diffLeftText;
  document.getElementById("diffRight").textContent = diffRightText;
}

function showPointsScreen() {
  document.getElementById("inputScreen").classList.add("hidden");
  document.getElementById("pointsScreen").classList.remove("hidden");

  const container = document.getElementById("playerScoresContainer");
  container.innerHTML = ''; // Clear previous content

  players.forEach(name => {
    const playerScoreDiv = document.createElement("div");
    playerScoreDiv.className = "player-score-entry"; // For styling

    const minusButton = document.createElement("button");
    minusButton.textContent = "-";
    minusButton.className = "score-adjust-btn minus-btn";
    minusButton.onclick = () => decreaseScore(name);

    const playerNameSpan = document.createElement("span");
    playerNameSpan.className = "player-name-display";
    // Display only the name on the points screen
    playerNameSpan.textContent = name + ": ";

    const scoreSpan = document.createElement("span");
    scoreSpan.id = `score-${name.replace(/\s+/g, '-')}`;
    scoreSpan.className = "player-score-value";
    scoreSpan.textContent = scores[name];

    const plusButton = document.createElement("button");
    plusButton.textContent = "+";
    plusButton.className = "score-adjust-btn plus-btn";
    plusButton.onclick = () => increaseScore(name);

    playerScoreDiv.appendChild(playerNameSpan);
    playerScoreDiv.appendChild(minusButton);
    playerScoreDiv.appendChild(scoreSpan);
    playerScoreDiv.appendChild(plusButton);

    container.appendChild(playerScoreDiv);
  });
}

function updatePlayerScoreDisplay(playerName) {
  const scoreSpan = document.getElementById(`score-${playerName.replace(/\s+/g, '-')}`);
  if (scoreSpan) {
    scoreSpan.textContent = scores[playerName];
  }
}

function increaseScore(playerName) {
  scores[playerName]++;
  updatePlayerScoreDisplay(playerName);
}

function decreaseScore(playerName) {
  if (scores[playerName] > 0) {
    scores[playerName]--;
    updatePlayerScoreDisplay(playerName);
  }
}

function nextRound() {
  newRound();
}

function showEndScreen() {
  document.getElementById("roundScreen").classList.add("hidden");
  document.getElementById("inputScreen").classList.add("hidden");
  document.getElementById("pointsScreen").classList.add("hidden");
  document.getElementById("endScreen").classList.remove("hidden");

  const sorted = Object.entries(scores).sort((a, b) => b[1] - a[1]);
  const result = sorted.map(([name, score]) => `<p>${name}: ${score} Punkte</p>`).join('');
  document.getElementById("ranking").innerHTML = result;
}

// Dynamische Namensfelder im Startmenü erzeugen
document.getElementById("playerCount").addEventListener("input", () => {
  const count = parseInt(document.getElementById("playerCount").value);
  const nameInputs = document.getElementById("nameInputs");
  nameInputs.innerHTML = '';
  for (let i = 0; i < count; i++) {
    nameInputs.innerHTML += `<input id="playerName${i}" placeholder="Spieler ${i + 1}"><br/>`;
  }
});
